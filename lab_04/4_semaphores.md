# Семафоры
семафоры unix определены наборы семафоров, основные свойства наборов семафоров это то что одной неделимой операцией можно изменить все или часть семафоров набора, в системе семафоры поддерживаются таблиуй семофров те в ядре unix есть таблица семафоров, любая таблица это массив структур, таблица семафоров это таблица структур в этой таблице описан каждый созданный в системе набор семафоров

Каждая таблица структрур описывает один набор семафорорв для каждого гнабора, указывается имя (int), user_id (uuid), причем процесс эффективный uuid которого совпадает с uuid создателя может изменять управляющие парметры набора и даже удалять набор. Права доступа, 
4. количество семафоров
5. Время изменение одного или нескольких изменений семафором последним процессом
6. Время последнего изменения управляющих параметров набора каким-либо процессом
7. Указатель на массив семафоров


Определена библиотека `<System.h>`  
Определены следующие системные вызовы
- semget()
- semcntl()
- semop()
```c
// Системный вызов создания набора семафоров
// nsems - кол-во семафоров на которых выполняется операция
// semflg - битовая маска
int semget(key_t key, int nsems, int semflg);  


int semctl(int semid, int semnum, int cmd, ...);

// sem operations
int semop(int semid, struct sembuf *sops, unsigned nsops);


struct sembuf
{
    unsigned short 	sem_num; // Индекс семафора в наборе
    short 	sem_op; // Операция над семафором
    short 	sem_flg // 
}
```

### Над семафором определены 3 операции:
1. sem_op > 0; Инкремент (Освобождение семафора)
2. sem_op = 0; Ожидание освобождение семафора, без его захват, ожидание, пока значение не станет 0.
3. sem_op < 0; Декримент. (Захват семафора)

### Флаги
- **IPC_NOWAIT** — флаг сообщает системе о нежелании процесса переходить в состояние ожидания семафора. Использование этого флага объясняется желанием избежать блокировки всех процессов находящихсяч в очереди к семафору, тк если процесс получил сигнал kill, который невозможно перехватить, то убиваемый сигнал не сможет освободить захваченный семафор и соответственно вае процессы в очереди к семафору будут заблокированы навсегда
- **SEM_UNDO** — флаг только для семафоров, данный флаг указывает ядру на необходимость отслеживать изменения значения семафора (в результате вызова SEM_OP). При завершении процесса, который вызвал sem_op, ядро ликвидирует все вызванные изменения для того, чтобы процессы не были заблокированы на всегда.

Пример
```c
#include <sys/types.h>
#include <system.h>
#include <sys/sem.h>

struct sembuf sops[2] = {0, -1, SEM_UNDO/IPC_NOWAIT};

int main()
{
    int perms = S_IRWXU/S_IRXWG/S_IRWXO; // U - user, G - group, O - others

    // Создается набор семафоров из 100, IPC_CREATE - полные права доступа для всех пользователей
    int fd = semget(100, 2, IPC_CREATE/perms);

    if (fd == -1)
    {
        perror("semget");
        exit(1);
    }

    // Определили операции на двух наборах семафорах
    // 3 параметр - размер параметра массива sembuf
    if (semop(fd, sops, 2) == -1)
        perror("semop")
    
    return 0;
}
```

Средство взаимодейтсвия — сегменты разделяемой памяти. Сегменты разделяемой памяти также создаются в области данных ядра системе (по той же причине, что и пайпы), поскольку адрессные пространства процессов - защищенные, взаимодействовать они могут через третье. На сегментах разделяемой памяти не определены никакие средства ислкючения

shm - shared memory
Пример 2
```c
#include <sys/shm.h>

int main()
{
    int perms = S_IRWXU | S_IRWXG | S_IRWXO;
    int fd = shmget(100, 1024, IPC_CREATE | perms);
    if (fd == -1)
    {
        perror("shmget");
        exit(1);
    }
    // shmat (shared memory attach) подключает сегмент разделяемой памяти к адресному пространству текущего процесса.
    char *addr = (char *)shmat(dt, NULL, 0);
    if (addr == (char *)-1)
    {
        perror("shmat");
        exit(1);
    }
    strcpy(addr, "abcd");
    if (shmdt(addr) == -1)
        perror("shmdt");
    return 0;
}
```


# Вопросы к лабораторной №4 UNIX
## Общие вопросы

### Основное свойство наборов семафоров?
можно одной неделимой операцией изменить весь или часть набора семафоров.

### Семафор Дейкстры и смафор в юникс
У семафора Дейкстры 2 операции(декремент и инкремент) и семафора в юникс 3 операции(декремент, инкримент и проверка на ноль)

### Зачем нужна проверка на ноль
Проверяет заблокирован ли семафор

## Производитель потребитель

### Задача производителей потребителей?
есть два типа процессов и буфер. процесс-производитель может только производить единицу продукции и помещать в буфер.
процесс-потребитель может только выбирать данные из буфера.

### Зачем нужен бинарный семафор?
чтобы организовать монопольный доступ к буферу.

### На чем блокируется потребитель и производитель?
потребитель - когда бинарный семафор равен 0 и когда счетчик заполненных равен 0.
производитель - когда бинарный семафор равен 0 и когда счетчик пустых равен 0.

### Алгоритм Дейкстры
вводится три семафора
два считающих один бинарный
бинарный служит для осуществления монопольного доступа к буферу
считающий семафор SEMEMPTY служит для определения количества пустых ячеек буфера
считающий семафор SEMFULL служит для определения количества заполненных ячеек буфера

### Критическая секция
критическая секция находится между 2-мя вызовами semop

### Последний аргумент функции semop
количество операций над семафорами

## Читатель писатель
### Потерянное обновление
читатель не может читать пока есть активный писатель и очередь активных писателей не пуста

### Охарактеризуйте задачу читателей-писателей
есть 2 типа процессов:
- процессы-читатели: могут только читать, могут работать параллельно
- процессы-писатели: в режиме монопольного доступа к отдельному полю - разделяемой переменной,  взаимоисключение обеспечивается бинарным семафором.

### Зачем в мониторе Хоара потерянное обновление
отдается приоритет процессам-писателям чтобы процессы-читатели прочитали актуальную информацию

### Вопросы по операциям над семафорами
варьируется от вопроса про операции

# ПП вопросы
## Почему команды для semop задаются именно так
- По алгоритму дейкстры
- `Почему`
- Дейкстра предложил решения на 2 считающих семафорах и одном бинарном